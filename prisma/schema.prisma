// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator prismaClassGenerator {
  provider = "prisma-class-generator"
  output   = "./generated/prisma-class-generator"
}

generator docs {
  provider = "node node_modules/prisma-docs-generator"
}

// generator erd {
//   provider = "prisma-erd-generator"
//   output   = "./generated/erd/graffinity_erd.pdf"
//   theme    = "forest"
// }

generator nestjsDto {
  provider                        = "prisma-generator-nestjs-dto"
  output                          = "./generated/dto/nestjs-dto"
  outputToNestJsResourceStructure = "false"
  exportRelationModifierClasses   = "true"
  reExport                        = "false"
  createDtoPrefix                 = "Create"
  updateDtoPrefix                 = "Update"
  dtoSuffix                       = "Dto"
  entityPrefix                    = ""
  entitySuffix                    = ""
  fileNamingStyle                 = "camel"
}

model EmailTemplate {
  id        Int       @id @default(autoincrement()) @db.Integer
  name      String    @unique
  subject   String
  body      String
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("email_template")
}

model Email {
  id        Int       @id @default(autoincrement()) @db.Integer
  user      User      @relation(fields: [userId], references: [id])
  userId    Int
  subject   String
  body      String
  status    String
  dateSent  DateTime? @map("date_sent")
  createdAt DateTime  @default(now()) @map("created_at")

  @@map("email")
}

model Topic {
  id           Int               @id @default(autoincrement()) @db.Integer
  name         String            @unique
  items        ItemToTopic[]
  TopicToBrand TopicToBrand[]
  UserToTopic  UserToTopic[]
  topicId      Int               @unique @map("topic_id")
  topic        Topic             @relation("TopicSubtopic", fields: [topicId], references: [id])
  subtopic     Topic[]           @relation("TopicSubtopic")
  posts        InfoPostToTopic[]
}

model Item {
  id         Int           @id @default(autoincrement()) @db.Integer
  name       String        @unique
  score      String
  brandId    Int           @map("brand_id")
  brand      Brand         @relation(fields: [brandId], references: [id])
  topics     ItemToTopic[]
  UserToItem UserToItem[]
  reports    Report[]
  InfoPost   InfoPost?
}

model ItemToTopic {
  item    Item  @relation(fields: [itemId], references: [id])
  itemId  Int   @map("item_id")
  topic   Topic @relation(fields: [topicId], references: [id])
  topicId Int   @map("topic_id")

  @@unique([itemId, topicId])
  @@map("item_to_topic")
}

model Brand {
  id     Int            @id @default(autoincrement()) @db.Integer
  name   String         @unique
  topics TopicToBrand[]
  items  Item[]
}

model TopicToBrand {
  topic   Topic @relation(fields: [topicId], references: [id])
  topicId Int   @map("topic_id")
  brand   Brand @relation(fields: [brandId], references: [id])
  brandId Int   @map("brand_id")

  @@unique([topicId, brandId])
  @@map("topic_to_brand")
}

model UserToItem {
  user     User   @relation(fields: [userId], references: [id])
  userId   Int    @map("user_id")
  item     Item   @relation(fields: [itemId], references: [id])
  itemId   Int    @map("item_id")
  listName String @unique @map("list_name")

  @@unique([userId, itemId])
  @@map("user_to_item")
}

model UserToTopic {
  user    User  @relation(fields: [userId], references: [id])
  userId  Int   @map("user_id")
  topic   Topic @relation(fields: [topicId], references: [id])
  topicId Int   @map("topic_id")

  @@unique([userId, topicId])
  @@map("user_to_topic")
}

model User {
  id          Int            @unique @default(autoincrement()) @db.Integer
  username    String         @unique
  password    String
  email       String        @unique
  name        String
  surname     String
  roles       RoleToUser[]
  filesReport Report[]
  UserToTopic UserToTopic[]
  UserToItem  UserToItem[]
  Email       Email[]
  votes       InfoPostVote[]
  posts       InfoPost[]

  @@map("user")
}

enum RoleEnum {
  USER
  ADMIN

  @@map("role_enum")
}

model UserRole {
  id    Int          @id @default(autoincrement()) @db.Integer
  name  RoleEnum     @unique @default(USER)
  users RoleToUser[]

  @@map("user_to_role")
}

model RoleToUser {
  user   User     @relation(fields: [userId], references: [id])
  userId Int      @map("user_id")
  roles  UserRole @relation(fields: [roleId], references: [id])
  roleId Int      @map("role_id")

  @@unique([userId, roleId])
  @@map("role_to_user")
}

model Report {
  id           Int              @unique @default(autoincrement()) @db.Integer
  createdAt    DateTime         @default(now()) @map("created_at")
  author       User             @relation(fields: [authorId], references: [id])
  authorId     Int              @unique @map("author_id")
  reportReason String           @map("report_reason")
  comment      String?
  status       ReportStatusEnum @default(SUBMITTED)
  item         Item             @relation(fields: [itemId], references: [id])
  itemId       Int              @unique @map("item_id")

  @@map("report")
}

enum ReportStatusEnum {
  SUBMITTED
  PENDING
  RESOLVED

  @@map("report_status_enum")
}

model InfoPost {
  id        Int               @unique @default(autoincrement()) @db.Integer
  author    User              @relation(fields: [authorId], references: [id])
  authorId  Int               @unique @map("author_id")
  item      Item              @relation(fields: [itemId], references: [id])
  itemId    Int               @unique @map("item_id")
  votes     InfoPostVote[]
  topics    InfoPostToTopic[]
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime?         @updatedAt @map("updated_at")
  isDeleted Boolean           @default(false) @map("is_deleted")
  deletedAt DateTime?         @map("deleted_at")

  @@map("info_post")
}

model InfoPostToTopic {
  infoPost   InfoPost @relation(fields: [infoPostId], references: [id])
  infoPostId Int      @map("info_post_id")
  topic      Topic    @relation(fields: [topicId], references: [id])
  topicId    Int      @map("topic_id")
  score      Int      @default(0)

  @@unique([infoPostId, topicId])
  @@map("info_post_to_topic")
}

model InfoPostVote {
  id         Int      @unique @default(autoincrement()) @db.Integer
  vote       VoteEnum
  user       User     @relation(fields: [userId], references: [id])
  userId     Int      @unique @map("user_id")
  infoPost   InfoPost @relation(fields: [infoPostId], references: [id])
  infoPostId Int      @unique @map("info_post_id")
  createdAt  DateTime @default(now()) @map("created_at")

  @@unique([userId, infoPostId])
  @@map("info_post_vote")
}

enum VoteEnum {
  UPVOTE
  DOWNVOTE

  @@map("vote_enum")
}
